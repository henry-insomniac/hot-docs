# /prd - 需求文档管理

## 描述
智能编写、更新和审查产品需求文档（PRD），确保需求清晰、完整、可落地。

## 适用场景
- **新功能需求分析**：如 Blog 文章草稿功能、插件热重载机制
- **现有功能优化需求**：如增量更新策略优化、性能提升方案
- **技术方案设计**：如插件安全边界设计、SSR 适配器架构
- **功能边界澄清**：明确 MVP 范围与可扩展点
- **开源发布规划**：LICENSE 选择、贡献指南框架

## 工作流程

### 1. 需求分析阶段
```
├─ 读取现有 docs/requirements.md
├─ 理解项目定位与架构约束（轻量、静态优先）
├─ 分析用户画像（开发者/团队维护者/个人博主/插件作者）
└─ 识别典型使用场景
```

### 2. 需求拆解阶段
```
├─ 功能目标（What）：要实现什么能力
├─ 非目标（What Not）：明确不做什么（避免范围蔓延）
├─ 用户价值（Why）：解决什么问题，带来什么收益
├─ 技术约束（How）：架构边界、性能要求、兼容性
└─ 验收标准（Done）：可测试、可验证的完成标准
```

### 3. 文档编写阶段
```
├─ 用户故事：作为 [角色]，我希望 [功能]，以便 [价值]
├─ 功能描述：详细说明功能行为与交互
├─ 技术方案草案：架构影响、数据流、接口设计
├─ 风险与依赖：技术风险、外部依赖、时间估算
└─ 里程碑规划：M0/M1/M2 等阶段目标
```

### 4. 审查与迭代
```
├─ 与架构文档对齐（docs/architecture.md）
├─ 与技术栈约束对齐（docs/tech-stack.md）
├─ 与路线图对齐（docs/todo.md）
└─ 补充遗漏的边界情况
```

## 输入示例

### 示例 1：新功能需求
```
/prd 设计 Blog 文章草稿功能（draft: true）的完整需求
```

**预期输出：**
- 功能描述：frontmatter 中 `draft: true` 的行为定义
- 用户故事：博主希望本地预览草稿，但不发布到生产环境
- 技术方案：dev 模式可见、build 模式过滤、可配置开关
- 验收标准：dev 可访问草稿、build 默认排除、`--include-drafts` 参数支持

### 示例 2：优化需求
```
/prd 优化 dev server 热更新性能，目标响应时间 < 100ms
```

**预期输出：**
- 当前问题：单文件变更响应 500ms，用户体验不够流畅
- 优化目标：< 100ms（80% 性能提升）
- 技术方案：增量索引更新、Markdown 渲染缓存、差量 nav 树更新
- 性能指标：响应时间、内存占用、首次启动时间影响

### 示例 3：技术方案
```
/prd 设计插件安全边界，防止恶意插件访问敏感文件
```

**预期输出：**
- 安全威胁：插件读取 .env、任意文件写入、命令注入
- 设计目标：最小权限原则、文件系统访问限制、运行时隔离
- 技术方案：PluginContext 受控 API、路径白名单、沙箱模式（可选）
- 兼容性：不破坏现有插件 API

## 输出格式

```markdown
# [功能名称] 产品需求文档

## 版本信息
- 版本：v1.0
- 作者：[姓名]
- 日期：2025-12-23
- 状态：草稿/审查中/已批准

## 1. 背景与目标

### 1.1 背景
（描述当前痛点或机会）

### 1.2 目标
- 产品目标：解决什么用户问题
- 技术目标：达成什么技术指标
- 业务目标：带来什么价值（如开源生态增长）

### 1.3 非目标
- 明确本次不做什么（避免范围蔓延）

## 2. 用户分析

### 2.1 目标用户
- 开发者：需求、痛点、期望
- 团队维护者：需求、痛点、期望
- 插件作者：需求、痛点、期望

### 2.2 用户故事
- 作为 [角色]，我希望 [功能]，以便 [价值]
- ...（3-5 个核心用户故事）

## 3. 功能需求

### 3.1 核心功能
（详细描述主要功能）

### 3.2 交互流程
（用户操作流程、系统响应）

### 3.3 边界情况
- 错误处理：插件加载失败、文件不存在
- 降级策略：增量更新失败回退到全量更新
- 性能保证：大文件、大规模站点

## 4. 技术方案（草案）

### 4.1 架构影响
- 影响的层（Foundation/Core/Adapters/Runtime/Ecosystem）
- 新增模块或接口
- 数据流变化

### 4.2 接口设计
```typescript
// 示例：插件 API 扩展
interface PluginContext {
  // 新增：受控文件系统访问
  fs: RestrictedFileSystem;
}
```

### 4.3 配置项
```typescript
// hot-docs.config.ts
{
  drafts: {
    enabled: true,      // dev 模式是否显示草稿
    buildInclude: false // build 模式是否包含草稿
  }
}
```

## 5. 验收标准

### 5.1 功能验收
- [ ] dev 模式可访问 `draft: true` 文章
- [ ] build 模式默认排除草稿文章
- [ ] `--include-drafts` 参数支持
- [ ] 草稿文章在列表中显示「草稿」标识

### 5.2 性能验收
- [ ] 单文件变更响应时间 < 100ms
- [ ] 内存占用增加 < 5%
- [ ] 首次启动时间增加 < 10%

### 5.3 兼容性验收
- [ ] 不破坏现有配置文件
- [ ] 不破坏现有插件 API
- [ ] 跨平台验证（macOS/Windows/Linux）

## 6. 风险与依赖

### 6.1 技术风险
- **高风险**：增量更新逻辑复杂，边界情况多
  缓解措施：充分测试、降级策略

### 6.2 依赖关系
- 依赖 M0 完成（基础 dev server）
- 阻塞 M2（主题系统需要稳定的 ContentIndex）

### 6.3 时间估算
- 开发：3-5 天
- 测试：1-2 天
- 文档：1 天
- 总计：5-8 天

## 7. 里程碑规划
- M1（基础功能）：实现核心逻辑
- M2（优化）：性能优化、边界情况处理
- M3（完善）：文档、测试、发布

## 8. 待讨论问题
- [ ] 是否支持部分草稿发布（基于 tag）？
- [ ] 草稿文章 URL 是否需要特殊前缀（如 `/draft/`）？
- [ ] 是否需要草稿文章过期机制？
```

## 相关文件
- **核心文档**：`docs/requirements.md`（项目整体需求）
- **架构约束**：`docs/architecture.md`（分层边界、数据流）
- **技术栈**：`docs/tech-stack.md`（技术选型、依赖清单）
- **任务清单**：`docs/todo.md`（与 TODO 对齐）

## 前置条件
- 已阅读 Hot Docs 项目文档（requirements/architecture/tech-stack）
- 理解五层架构边界与设计原则
- 理解"轻量、静态优先"的产品定位

## 注意事项

### 1. 需求粒度
- **太粗**：「优化性能」→ 具体指标不明确
- **太细**：「第 123 行改为异步」→ 属于实现细节
- **合适**：「单文件变更响应时间 < 100ms」→ 可验证的指标

### 2. 与架构对齐
- 任何新功能都必须考虑：
  - 是否符合分层边界（不跨层依赖）
  - 是否破坏插件契约（apiVersion 升级）
  - 是否影响"轻量"原则（依赖大小、运行时负担）

### 3. 开源友好性
- 考虑第三方开发者视角：
  - 功能是否易于理解和使用
  - 是否有清晰的文档和示例
  - 是否有合理的错误提示

### 4. 验收标准具体化
- ❌ 「功能正常工作」→ 太模糊
- ✅ 「dev 模式可访问草稿，build 模式排除，`--include-drafts` 支持」→ 可测试

### 5. 避免技术驱动
- 需求应从**用户价值**出发，而非「我们有技术 X，可以做功能 Y」
- 每个功能都要回答：「用户为什么需要这个？」

## 最佳实践

### ✅ 好的需求文档特征
- 目标清晰：解决什么问题、带来什么价值
- 边界明确：做什么、不做什么
- 可验收：有具体、可测试的验收标准
- 与架构对齐：不违反设计原则
- 考虑风险：识别技术风险和缓解措施

### ❌ 避免的陷阱
- 需求蔓延：不断加功能，导致里程碑延期
- 技术细节过度：PRD 不是设计文档，不要写具体实现
- 忽略边界：缺少错误处理、降级策略
- 脱离架构：不考虑分层边界、插件契约

## 配合使用的 Skills
- `/arch` - 需求涉及架构变更时，同步更新架构文档
- `/tech-stack` - 需求引入新技术时，评估技术栈影响
- `/roadmap` - 需求确定后，更新路线图和里程碑
- `/todo` - 需求通过后，拆分为可执行的任务
